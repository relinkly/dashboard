<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZL & BVS Active Retail</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 1200px;
      background: #f9f9f9;
      font-size: 11px;
      padding: 0 10px;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      font-size: 16px;
      margin-top: 40px;
      margin-bottom: 10px;
      color: #333;
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 20px;
    }

    .tab-button {
      cursor: pointer;
      padding: 10px 20px;
      background: #eee;
      border: 1px solid #ccc;
      border-bottom: none;
      font-weight: bold;
      font-size: 14px;
      border-radius: 5px 5px 0 0;
      user-select: none;
      transition: background-color 0.3s;
    }

    .tab-button.active {
      background: white;
      border-bottom: 2px solid white;
      color: #333;
    }

    .tab-content {
      display: none;
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 0 5px 5px 5px;
    }

    .tab-content.active {
      display: block;
    }

    table.dataTable {
      width: 100% !important;
      margin-bottom: 40px;
      font-size: 11px;
      box-sizing: border-box;
      overflow-x: auto;
      display: block;
    }

    table.dataTable th,
    table.dataTable td {
      font-size: 11px !important;
      white-space: nowrap;
      text-align: center !important;
    }

    #grid-filter-container {
      max-width: 1200px;
      margin: 0 auto 20px auto;
      text-align: center;
    }

    #grid-filter-container button {
      margin: 3px 5px;
      padding: 6px 12px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid #888;
      border-radius: 3px;
      background-color: #f0f0f0;
      transition: background-color 0.2s;
    }

    #grid-filter-container button:hover {
      background-color: #ddd;
    }

    #grid-filter-container button.active {
      background-color: #2196F3;
      color: white;
      border-color: #0b7dda;
    }

    #watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      user-select: none;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0.1;
      color: #000000;
      font-size: 10vw;
      font-weight: 900;
      font-family: Arial, sans-serif;
      text-align: center;
      transform: translate(-50%, -50%);
      overflow: hidden;
    }

    #watermark > div {
      margin: 0.1em 0;
      width: 100%;
      white-space: normal;
    }

    .highlighted {
      background-color: #ffff99 !important;
    }

    /* Hide the default DataTables search box */
    .dataTables_filter {
      display: none !important;
    }

    #chart h1, #chart h2 {
  text-align: center;
  color: #2c3e50; /* Darker blue-gray for better look */
  margin-bottom: 15px;
}

  </style>
</head>
<body>

<div id="watermark"></div>

<!-- Back button -->
<div style="margin-bottom: 20px;">
  <button onclick="window.location.href='channelmenu.html'" style="padding: 6px 12px; font-size: 12px; cursor: pointer;">
    &larr; Back to Menu
  </button>
</div>

<!-- New main heading -->
<h1 style="text-align: center; font-size: 18px; margin-bottom: 30px; color: #333;">
  ZL & BVS Active Retail
</h1>
<p>Updated till: 30-07-25</p>


<div id="grid-filter-container">
  <button id="grid-filter-clear">Clear</button>
</div>

<div class="tabs">
  <div class="tab-button" data-tab="chart">Chart</div>
  <div class="tab-button" data-tab="zl">ZL</div>
  <div class="tab-button" data-tab="etop">BVS</div>
  
</div>



  </div>
</div>

  
<div id="etop" class="tab-content">
  <h1>Grid Level</h1>
  <table id="sheetTable7" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>

  <h1>Franchise Level</h1>
  <table id="sheetTable8" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

  
<div id="zl" class="tab-content">
  <h1>Grid Level</h1>
  <table id="sheetTable3" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>

  <h1>Franchise Level</h1>
  <table id="sheetTable4" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>



<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<!-- PapaParse CSV parser -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
  let dataTables = {};
  let loadedCount = 0;
  let zlChartInstance = null;
  let bvsChartInstance = null;


  function applyGridFilter(value) {
    if (!dataTables || Object.keys(dataTables).length === 0) return;
    Object.values(dataTables).forEach(({ dt, gridColIndex }) => {
      if (gridColIndex === -1) return;
      dt.columns(gridColIndex).search(value, true, false, true).draw();
    });
  }

  const gridIds = [
    "Grid 101", "Grid 105", "Grid 106", "Grid 102", "Grid 104", "Grid 103",
    "Grid 401", "Grid 402", "Grid 403", "Grid 404", "Grid 405",
    "Grid 501", "Grid 502", "Grid 503", "Grid 504", "Grid 505", "Grid 506", "Grid 507", "Grid 508", "Grid 509",
    "Grid 601", "Grid 602", "Grid 603", "Grid 604", "Grid 605"
  ];

  const gridFilterContainer = document.getElementById('grid-filter-container');
  const clearBtn = document.getElementById('grid-filter-clear');
  const selectedGrids = new Set();

  gridIds.forEach(gridId => {
    const btn = document.createElement('button');
    btn.textContent = gridId;
    btn.addEventListener('click', () => {
      if (selectedGrids.has(gridId)) {
        selectedGrids.delete(gridId);
      } else {
        selectedGrids.add(gridId);
      }
      updateFilter();
      updateButtonStyles();
    });
    gridFilterContainer.insertBefore(btn, clearBtn);
  });

  clearBtn.addEventListener('click', () => {
    selectedGrids.clear();
    updateFilter();
    updateButtonStyles();
  });

  function updateFilter() {
    const regex = Array.from(selectedGrids)
      .map(g => g.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))
      .join('|');
    applyGridFilter(selectedGrids.size === 0 ? '' : regex);
  }

  function updateButtonStyles() {
    const buttons = gridFilterContainer.querySelectorAll('button');
    buttons.forEach(btn => {
      if (btn === clearBtn) {
        btn.classList.toggle('active', selectedGrids.size === 0);
      } else {
        btn.classList.toggle('active', selectedGrids.has(btn.textContent));
      }
    });
  }

  function renderBarChart(ctx, labels, data) {
  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Avg Ach%',
        data: data,
        backgroundColor: 'rgba(66, 165, 245, 0.7)', // softer blue with opacity
        borderColor: 'rgba(30, 136, 229, 1)',
        borderWidth: 1,
        borderRadius: 5,  // rounded corners on bars
        hoverBackgroundColor: 'rgba(30, 136, 229, 0.9)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: 20,
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          grid: {
            color: '#e0e0e0'
          },
          ticks: {
            color: '#34495e',
            font: { size: 12 }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            color: '#34495e',
            font: { size: 12 }
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          labels: {
            color: '#34495e',
            font: { size: 14, weight: 'bold' }
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(52, 73, 94, 0.8)',
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          padding: 10,
          cornerRadius: 4
        }
      }
    }
  });
}

  const sheets = [
    { url: "https://docs.google.com/spreadsheets/d/1GsuErz0oKGJSlk7aJ7hUUZi8dJ-tObZ1ll73AhqtNZY/export?format=csv&gid=0", tableId: "sheetTable3" },  // BVS grid level
    { url: "https://docs.google.com/spreadsheets/d/1GsuErz0oKGJSlk7aJ7hUUZi8dJ-tObZ1ll73AhqtNZY/export?format=csv&gid=1196662913", tableId: "sheetTable4" }, // BVS franchise
    { url: "https://docs.google.com/spreadsheets/d/1GsuErz0oKGJSlk7aJ7hUUZi8dJ-tObZ1ll73AhqtNZY/export?format=csv&gid=1028097947", tableId: "sheetTable7" }, // ZL grid level
    { url: "https://docs.google.com/spreadsheets/d/1GsuErz0oKGJSlk7aJ7hUUZi8dJ-tObZ1ll73AhqtNZY/export?format=csv&gid=1979603911", tableId: "sheetTable8" }  // ZL franchise
  ];

  sheets.forEach(({ url, tableId }) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        const data = results.data;
        const table = document.getElementById(tableId);
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        thead.innerHTML = "";
        tbody.innerHTML = "";

        const columns = Object.keys(data[0] || {});
        const trHead = document.createElement("tr");
        columns.forEach(col => {
          const th = document.createElement("th");
          th.textContent = col;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        data.forEach(row => {
          const tr = document.createElement("tr");
          columns.forEach(col => {
            const td = document.createElement("td");
            td.textContent = row[col];
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        const dt = $(table).DataTable({
          paging: false,
          searching: true,
          info: false,
          order: [],
          autoWidth: false,
          language: {
            paginate: { previous: "<", next: ">" }
          }
        });

        $(table).on('click', 'tbody td', function () {
          const $row = $(this).closest('tr');
          $row.toggleClass('highlighted');
        });

        const gridColIndex = columns.findIndex(c => c.trim().toLowerCase() === "grid");
        dataTables[tableId] = { dt, columns, gridColIndex };

        // Render chart for BVS grid table (sheetTable3)
        if (tableId === "sheetTable3") {
          const gridKey = columns.find(c => c.toLowerCase().includes("grid"));
          const avgAchKey = columns.find(c => c.toLowerCase().includes("avg") && c.toLowerCase().includes("ach"));

          if (gridKey && avgAchKey) {
            const labels = data.map(r => r[gridKey]);
            const values = data.map(r => parseFloat(r[avgAchKey]) || 0);

            const ctxBVS = document.getElementById('bvsGridBarChart').getContext('2d');
            if (bvsChartInstance) bvsChartInstance.destroy();
            bvsChartInstance = renderBarChart(ctxBVS, labels, values);
          }
        }

        // Render chart for ZL grid table (sheetTable7)
        if (tableId === "sheetTable7") {
          const gridKey = columns.find(c => c.toLowerCase().includes("grid"));
          const avgAchKey = columns.find(c => c.toLowerCase().includes("avg") && c.toLowerCase().includes("ach"));

          if (gridKey && avgAchKey) {
            const labels = data.map(r => r[gridKey]);
            const values = data.map(r => parseFloat(r[avgAchKey]) || 0);

            const ctxZL = document.getElementById('zlGridBarChart').getContext('2d');
            if (zlChartInstance) zlChartInstance.destroy();
            zlChartInstance = renderBarChart(ctxZL, labels, values);
          }
        }

        loadedCount++;
        if (loadedCount === sheets.length) {
          // Removed calls to undefined functions updateButtonStyles and applyGridFilter
          // You can add your logic here if needed
          console.log('All sheets loaded and charts rendered');
        }
      }
    });
  });

  // Tabs functionality
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      const tab = button.getAttribute('data-tab');

      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

      button.classList.add('active');
      document.getElementById(tab).classList.add('active');
    });
  });

  // Make Chart tab active on page load
  window.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    document.querySelector('.tab-button[data-tab="chart"]').classList.add('active');
    document.getElementById("zl").classList.add('active');
  });
</script>

</body>
</html>


